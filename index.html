<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ®ÿßÿ≤€å ÿ≠⁄©ŸÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            background: linear-gradient(135deg, #0d4f2b 0%, #1a7a45 50%, #0d4f2b 100%);
            color: #fff;
        }

        .game-wrapper {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
            padding: 6px;
            gap: 6px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            flex-shrink: 0;
        }

        .title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #ffd700;
        }

        .scores {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
        }

        .score-box {
            padding: 4px 10px;
            border-radius: 15px;
            background: rgba(0,0,0,0.4);
            font-weight: 600;
        }

        .score-box.us { border: 2px solid #4ecdc4; }
        .score-box.them { border: 2px solid #ff6b6b; }

        /* Info Bar */
        .info-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 6px;
            background: rgba(0,0,0,0.25);
            border-radius: 8px;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .info-item i { color: #ffd700; font-size: 0.65rem; }

        /* Opponents */
        .opponents-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            padding: 4px 0;
        }

        .opponent {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .opponent-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            position: relative;
        }

        .opponent-avatar.partner { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .opponent-avatar.enemy { background: linear-gradient(135deg, #ff6b6b, #c0392b); }

        .opponent-name { font-size: 0.65rem; opacity: 0.9; }

        .opponent.active .opponent-avatar {
            box-shadow: 0 0 0 3px #ffd700, 0 0 15px rgba(255,215,0,0.5);
        }

        .crown-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            color: #ffd700;
            font-size: 0.75rem;
        }

        .trump-indicator {
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #000;
            font-size: 0.55rem;
            padding: 1px 5px;
            border-radius: 6px;
            font-weight: 700;
        }

        /* Play Area */
        .play-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        .table {
            width: 90%;
            max-width: 280px;
            aspect-ratio: 1.3;
            background: radial-gradient(ellipse at center, #2d6a30 0%, #1e4d25 70%, #153a1a 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.5),
                0 0 0 6px #5d3a1a,
                0 0 0 10px #3d2510;
        }

        .card-slot {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-slot.top { top: 5%; left: 50%; transform: translateX(-50%); }
        .card-slot.bottom { bottom: 5%; left: 50%; transform: translateX(-50%); }
        .card-slot.left { left: 8%; top: 50%; transform: translateY(-50%); }
        .card-slot.right { right: 8%; top: 50%; transform: translateY(-50%); }

        /* Player Section */
        .player-section {
            flex-shrink: 0;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 14px 14px 0 0;
            margin: 0 -6px -6px -6px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
        }

        .player-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 0.9rem;
        }

        .player-name { font-weight: 600; font-size: 0.85rem; }

        .player-section.active .player-avatar {
            box-shadow: 0 0 0 3px #ffd700, 0 0 15px rgba(255,215,0,0.5);
        }

        /* Hand - ⁄©ÿßÿ±ÿ™‚ÄåŸáÿß */
        .hand {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 3px;
            padding: 4px;
        }

        /* Cards */
        .card {
            width: 36px;
            height: 52px;
            border-radius: 5px;
            background: linear-gradient(145deg, #fff 0%, #f5f5f5 100%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            flex-shrink: 0;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .card.selected {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4), 0 0 0 2px #ffd700;
        }

        .card.trump {
            border: 2px solid #ffd700;
        }

        .card-corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .card-corner.bl {
            align-self: flex-end;
            transform: rotate(180deg);
        }

        .card-rank { font-size: 0.6rem; font-weight: 700; }
        .card-suit-small { font-size: 0.55rem; }

        .card-suit-big {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            opacity: 0.85;
        }

        .card.red .card-corner, .card.red .card-suit-big { color: #e63946; }
        .card.black .card-corner, .card.black .card-suit-big { color: #1a1a1a; }

        /* Table cards */
        .table-card {
            width: 38px;
            height: 54px;
            animation: dealCard 0.2s ease-out;
        }

        @keyframes dealCard {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            padding: 15px;
        }

        .modal.show { opacity: 1; visibility: visible; }

        .modal-box {
            background: linear-gradient(145deg, #2a3a4a, #1a2530);
            border-radius: 16px;
            padding: 20px;
            max-width: 320px;
            width: 100%;
            text-align: center;
            border: 2px solid #ffd700;
        }

        .modal-title {
            font-size: 1.2rem;
            color: #ffd700;
            margin-bottom: 12px;
        }

        .trump-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .trump-btn {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid transparent;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .trump-btn:active { transform: scale(0.95); }
        .trump-btn.spades, .trump-btn.clubs { background: #e8e8e8; color: #1a1a1a; }
        .trump-btn.hearts, .trump-btn.diamonds { background: #ffe8e8; color: #e63946; }
        .trump-btn.special {
            grid-column: span 2;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            font-size: 0.9rem;
        }
        .trump-btn:hover { border-color: #ffd700; }
        .trump-label { font-size: 0.6rem; }

        .preview-cards {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 12px;
        }

        .preview-cards .card {
            width: 32px;
            height: 46px;
            cursor: default;
        }

        .preview-cards .card-rank { font-size: 0.55rem; }
        .preview-cards .card-suit-small { font-size: 0.5rem; }
        .preview-cards .card-suit-big { font-size: 0.85rem; }

        .btn {
            padding: 10px 25px;
            border-radius: 20px;
            border: none;
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #1a1a1a;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 12px;
        }

        .btn:active { transform: scale(0.95); }
        .btn.secondary { background: #555; color: #fff; }

        /* Winner Popup */
        .winner-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #1a1a1a;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            z-index: 999;
            transition: transform 0.25s ease;
        }

        .winner-popup.show { transform: translate(-50%, -50%) scale(1); }

        /* Start Screen */
        .start-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0d4f2b 0%, #1a7a45 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .start-screen.hidden { display: none; }

        .logo {
            font-size: 3.5rem;
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
        }

        .logo span:nth-child(1), .logo span:nth-child(4) { color: #1a1a1a; }
        .logo span:nth-child(2), .logo span:nth-child(3) { color: #e63946; }

        .logo span { animation: bounce 2s ease-in-out infinite; }
        .logo span:nth-child(2) { animation-delay: 0.2s; }
        .logo span:nth-child(3) { animation-delay: 0.4s; }
        .logo span:nth-child(4) { animation-delay: 0.6s; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .start-title { font-size: 2.2rem; color: #ffd700; margin-bottom: 5px; }
        .start-subtitle { opacity: 0.8; margin-bottom: 30px; font-size: 0.9rem; }

        .start-btn {
            padding: 15px 45px;
            font-size: 1.1rem;
            border-radius: 40px;
            border: none;
            background: linear-gradient(135deg, #ffd700, #ffb300);
            color: #1a1a1a;
            font-weight: 700;
            cursor: pointer;
        }

        .start-btn:active { transform: scale(0.95); }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-height: 600px) {
            .header { padding: 6px 10px; }
            .title { font-size: 1rem; }
            .info-bar { padding: 4px; font-size: 0.65rem; }
            .opponent-avatar { width: 30px; height: 30px; }
            .table { max-width: 220px; }
            .card { width: 32px; height: 46px; }
            .card-rank { font-size: 0.55rem; }
            .card-suit-big { font-size: 0.9rem; }
            .table-card { width: 32px; height: 46px; }
        }

        @media (min-width: 400px) {
            .card { width: 40px; height: 58px; }
            .card-rank { font-size: 0.7rem; }
            .card-suit-small { font-size: 0.6rem; }
            .card-suit-big { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="logo">
            <span>‚ô†</span><span>‚ô•</span><span>‚ô¶</span><span>‚ô£</span>
        </div>
        <h1 class="start-title">ÿ≠⁄©ŸÖ</h1>
        <p class="start-subtitle">ÿ®ÿßÿ≤€å ⁄ÜŸáÿßÿ± ŸÜŸÅÿ±Ÿá</p>
        <button class="start-btn" id="startBtn">ÿ¥ÿ±Ÿàÿπ ÿ®ÿßÿ≤€å</button>
    </div>

    <!-- Game -->
    <div class="game-wrapper hidden" id="gameWrapper">
        <div class="header">
            <div class="title"><i class="fas fa-crown"></i> ÿ≠⁄©ŸÖ</div>
            <div class="scores">
                <div class="score-box us">ŸÖÿß: <span id="scoreA">0</span></div>
                <div class="score-box them">ÿ¢ŸÜŸáÿß: <span id="scoreB">0</span></div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item"><i class="fas fa-layer-group"></i> <span id="trickNum">0</span>/13</div>
            <div class="info-item"><i class="fas fa-trophy"></i> <span id="tricksA">0</span></div>
            <div class="info-item"><i class="fas fa-flag"></i> <span id="tricksB">0</span></div>
            <div class="info-item"><i class="fas fa-chess-king"></i> <span id="trumpDisplay">-</span></div>
        </div>

        <div class="opponents-row">
            <div class="opponent" id="player4Box">
                <div class="opponent-avatar enemy">
                    <i class="fas fa-robot"></i>
                    <span class="crown-badge hidden" id="crown4"><i class="fas fa-crown"></i></span>
                    <span class="trump-indicator hidden" id="trumpBadge4"></span>
                </div>
                <span class="opponent-name">ÿ≠ÿ±€åŸÅ €≤</span>
            </div>
            <div class="opponent" id="player3Box">
                <div class="opponent-avatar partner">
                    <i class="fas fa-user"></i>
                    <span class="crown-badge hidden" id="crown3"><i class="fas fa-crown"></i></span>
                    <span class="trump-indicator hidden" id="trumpBadge3"></span>
                </div>
                <span class="opponent-name">€åÿßÿ± ÿ¥ŸÖÿß</span>
            </div>
            <div class="opponent" id="player2Box">
                <div class="opponent-avatar enemy">
                    <i class="fas fa-robot"></i>
                    <span class="crown-badge hidden" id="crown2"><i class="fas fa-crown"></i></span>
                    <span class="trump-indicator hidden" id="trumpBadge2"></span>
                </div>
                <span class="opponent-name">ÿ≠ÿ±€åŸÅ €±</span>
            </div>
        </div>

        <div class="play-area">
            <div class="table">
                <div class="card-slot top" id="slot3"></div>
                <div class="card-slot left" id="slot4"></div>
                <div class="card-slot right" id="slot2"></div>
                <div class="card-slot bottom" id="slot1"></div>
            </div>
        </div>

        <div class="player-section" id="player1Box">
            <div class="player-info">
                <div class="player-avatar">
                    <i class="fas fa-user"></i>
                    <span class="crown-badge hidden" id="crown1"><i class="fas fa-crown"></i></span>
                    <span class="trump-indicator hidden" id="trumpBadge1"></span>
                </div>
                <span class="player-name">ÿ¥ŸÖÿß</span>
            </div>
            <div class="hand" id="handCards"></div>
        </div>
    </div>

    <div class="winner-popup" id="winnerPopup"></div>

    <div class="modal" id="trumpModal">
        <div class="modal-box">
            <h2 class="modal-title"><i class="fas fa-crown"></i> ÿßŸÜÿ™ÿÆÿßÿ® ÿ≠⁄©ŸÖ</h2>
            <p style="opacity: 0.7; margin-bottom: 8px; font-size: 0.8rem;">€µ ⁄©ÿßÿ±ÿ™ ÿßŸàŸÑ:</p>
            <div class="preview-cards" id="previewCards"></div>
            <div class="trump-grid">
                <button class="trump-btn spades" data-trump="spades"><span>‚ô†</span><span class="trump-label">Ÿæ€å⁄©</span></button>
                <button class="trump-btn hearts" data-trump="hearts"><span>‚ô•</span><span class="trump-label">ÿØŸÑ</span></button>
                <button class="trump-btn diamonds" data-trump="diamonds"><span>‚ô¶</span><span class="trump-label">ÿÆÿ¥ÿ™</span></button>
                <button class="trump-btn clubs" data-trump="clubs"><span>‚ô£</span><span class="trump-label">⁄Øÿ¥ŸÜ€åÿ≤</span></button>
                <button class="trump-btn special" data-trump="ners"><span>(2) ŸÜÿ±ÿ≥</span></button>
                <button class="trump-btn special" data-trump="asners"><span>(A2) ÿ¢ÿ≥‚ÄåŸÜÿ±ÿ≥</span></button>
                <button class="trump-btn special" data-trump="sers"><span>(A) ÿ≥ÿ±ÿ≥</span></button>
            </div>
        </div>
    </div>

    <div class="modal" id="roundModal">
        <div class="modal-box">
            <h2 class="modal-title" id="roundTitle">Ÿæÿß€åÿßŸÜ ÿ±ÿßŸÜÿØ</h2>
            <p id="roundMsg"></p>
            <button class="btn" id="nextRoundBtn">ÿ±ÿßŸÜÿØ ÿ®ÿπÿØ€å</button>
        </div>
    </div>

    <div class="modal" id="endModal">
        <div class="modal-box">
            <h2 class="modal-title" id="endTitle">Ÿæÿß€åÿßŸÜ</h2>
            <p id="endMsg"></p>
            <button class="btn" id="newGameBtn">ÿ®ÿßÿ≤€å ÿ¨ÿØ€åÿØ</button>
        </div>
    </div>

    <div class="modal" id="kotModal">
        <div class="modal-box">
            <h2 class="modal-title"><i class="fas fa-trophy"></i> ⁄©ÿ™!</h2>
            <p id="kotMsg"></p>
            <p style="margin: 12px 0;">ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿ®ÿßŸÖÿü</p>
            <button class="btn" id="bamYes">ÿ®ŸÑŸá</button>
            <button class="btn secondary" id="bamNo">ÿÆ€åÿ±</button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        const SUITS = ['spades', 'hearts', 'diamonds', 'clubs'];
        const SYMBOLS = { spades: '‚ô†', hearts: '‚ô•', diamonds: '‚ô¶', clubs: '‚ô£' };
        const NAMES = { spades: 'Ÿæ€å⁄©', hearts: 'ÿØŸÑ', diamonds: 'ÿÆÿ¥ÿ™', clubs: '⁄Øÿ¥ŸÜ€åÿ≤' };
        const RANKS = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
        const NEXT = {1: 2, 2: 3, 3: 4, 4: 1};
        const PARTNER = { 1: 3, 2: 4, 3: 1, 4: 2 };

        const G = {
            players: {
                1: { name: 'ÿ¥ŸÖÿß', hand: [], team: 'A' },
                2: { name: 'ÿ≠ÿ±€åŸÅ€±', hand: [], team: 'B' },
                3: { name: '€åÿßÿ±', hand: [], team: 'A' },
                4: { name: 'ÿ≠ÿ±€åŸÅ€≤', hand: [], team: 'B' }
            },
            hakem: null, trump: null, trumpMode: 'normal',
            trick: [], leadSuit: null, current: null, starter: null,
            tricksWon: { A: 0, B: 0 }, score: { A: 0, B: 0 },
            trickNum: 0, phase: 'idle', processing: false,
            selectedCard: null, deck: [],
            memory: { played: [], voids: {}, aces: {}, kings: {} },
            kotTeam: null, bamReq: false
        };

        const $ = id => document.getElementById(id);
        const delay = ms => new Promise(r => setTimeout(r, ms));

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function makeDeck() {
            const d = [];
            for (const s of SUITS) for (const r of RANKS) d.push({ suit: s, rank: r });
            return d;
        }

        function cardVal(c, mode) {
            if (mode === 'ners') {
                const o = ['A','K','Q','J','10','9','8','7','6','5','4','3','2'];
                return o.length - o.indexOf(c.rank);
            }
            if (mode === 'asners') {
                const o = ['K','Q','J','10','9','8','7','6','5','4','3','2','A'];
                return o.length - o.indexOf(c.rank);
            }
            return RANKS.indexOf(c.rank) + 1;
        }

        function cmpCards(a, b, lead, mode, trump) {
            const ta = mode === 'normal' && a.suit === trump;
            const tb = mode === 'normal' && b.suit === trump;
            if (mode === 'sers') {
                if (a.suit === lead && b.suit !== lead) return 1;
                if (a.suit !== lead && b.suit === lead) return -1;
                if (a.suit !== lead && b.suit !== lead) return 0;
                return cardVal(a, mode) - cardVal(b, mode);
            }
            if (ta && !tb) return 1;
            if (!ta && tb) return -1;
            if (ta && tb) return cardVal(a, mode) - cardVal(b, mode);
            if (a.suit === lead && b.suit !== lead) return 1;
            if (a.suit !== lead && b.suit === lead) return -1;
            if (a.suit === lead) return cardVal(a, mode) - cardVal(b, mode);
            return 0;
        }

        function trickWinner(trick, lead, mode, trump) {
            let w = trick[0];
            for (let i = 1; i < trick.length; i++) {
                if (cmpCards(trick[i].card, w.card, lead, mode, trump) > 0) w = trick[i];
            }
            return w;
        }

        function sortHand(hand, trump, mode) {
            const bins = { spades: [], hearts: [], diamonds: [], clubs: [] };
            for (const c of hand) bins[c.suit].push(c);
            for (const s of SUITS) bins[s].sort((a, b) => cardVal(b, mode) - cardVal(a, mode));
            const out = [];
            if (mode === 'normal' && trump) {
                out.push(...bins[trump]);
                for (const s of SUITS.filter(x => x !== trump)) out.push(...bins[s]);
            } else {
                for (const s of SUITS) out.push(...bins[s]);
            }
            return out;
        }

        function createCard(c, size = '') {
            const el = document.createElement('div');
            const red = c.suit === 'hearts' || c.suit === 'diamonds';
            const isTrump = G.trumpMode === 'normal' && c.suit === G.trump;
            el.className = `card ${red ? 'red' : 'black'}${isTrump ? ' trump' : ''}${size ? ' ' + size : ''}`;
            el.innerHTML = `
                <div class="card-corner"><span class="card-rank">${c.rank}</span><span class="card-suit-small">${SYMBOLS[c.suit]}</span></div>
                <span class="card-suit-big">${SYMBOLS[c.suit]}</span>
                <div class="card-corner bl"><span class="card-rank">${c.rank}</span><span class="card-suit-small">${SYMBOLS[c.suit]}</span></div>
            `;
            return el;
        }

        function playable(pid) {
            const h = G.players[pid].hand;
            if (!G.leadSuit || G.trick.length === 0) return h;
            const f = h.filter(c => c.suit === G.leadSuit);
            return f.length ? f : h;
        }

        function renderHand() {
            const cont = $('handCards');
            cont.innerHTML = '';
            const h = sortHand(G.players[1].hand, G.trump, G.trumpMode);
            G.players[1].hand = h;
            const can = playable(1);
            const myTurn = G.phase === 'play' && G.current === 1 && !G.processing;

            for (const c of h) {
                const el = createCard(c);
                const ok = myTurn && can.some(x => x.suit === c.suit && x.rank === c.rank);
                if (!ok) el.classList.add('disabled');
                if (ok) el.onclick = () => selectCard(c, el);
                if (G.selectedCard && G.selectedCard.suit === c.suit && G.selectedCard.rank === c.rank) {
                    el.classList.add('selected');
                }
                cont.appendChild(el);
            }
        }

        function selectCard(c, el) {
            if (G.selectedCard && G.selectedCard.suit === c.suit && G.selectedCard.rank === c.rank) {
                G.selectedCard = null;
                playCardHuman(c);
            } else {
                G.selectedCard = c;
                renderHand();
            }
        }

        async function playCardHuman(c) {
            G.processing = true;
            doPlayCard(1, c);
            await nextTurn();
        }

        function doPlayCard(pid, c) {
            const h = G.players[pid].hand;
            const i = h.findIndex(x => x.suit === c.suit && x.rank === c.rank);
            if (i > -1) h.splice(i, 1);
            G.trick.push({ player: pid, card: c });
            if (G.trick.length === 1) G.leadSuit = c.suit;
            G.memory.played.push({ ...c });
            if (c.rank === 'A') G.memory.aces[c.suit] = true;
            if (c.rank === 'K') G.memory.kings[c.suit] = true;
            if (G.leadSuit && c.suit !== G.leadSuit) {
                if (!G.memory.voids[pid]) G.memory.voids[pid] = [];
                if (!G.memory.voids[pid].includes(G.leadSuit)) G.memory.voids[pid].push(G.leadSuit);
            }
            renderTableCard(pid, c);
            if (pid === 1) renderHand();
        }

        function renderTableCard(pid, c) {
            const slot = $(`slot${pid}`);
            slot.innerHTML = '';
            slot.appendChild(createCard(c, 'table-card'));
        }

        function clearTable() {
            for (let i = 1; i <= 4; i++) $(`slot${i}`).innerHTML = '';
        }

        function updateUI() {
            $('scoreA').textContent = G.score.A;
            $('scoreB').textContent = G.score.B;
            $('tricksA').textContent = G.tricksWon.A;
            $('tricksB').textContent = G.tricksWon.B;
            $('trickNum').textContent = G.trickNum;

            let td = '-';
            if (G.trump || G.trumpMode !== 'normal') {
                if (G.trumpMode === 'normal') td = SYMBOLS[G.trump];
                else if (G.trumpMode === 'ners') td = '(2)';
                else if (G.trumpMode === 'asners') td = '(A2)';
                else td = '(A)';
            }
            $('trumpDisplay').textContent = td;

            for (let i = 1; i <= 4; i++) {
                const box = $(`player${i}Box`);
                if (box) box.classList.toggle('active', G.current === i);
            }

            for (let i = 1; i <= 4; i++) {
                $(`crown${i}`).classList.add('hidden');
                $(`trumpBadge${i}`).classList.add('hidden');
            }
            if (G.hakem) {
                $(`crown${G.hakem}`).classList.remove('hidden');
                if (G.trump || G.trumpMode !== 'normal') {
                    const b = $(`trumpBadge${G.hakem}`);
                    b.classList.remove('hidden');
                    b.textContent = G.trumpMode === 'normal' ? SYMBOLS[G.trump] : (G.trumpMode === 'ners' ? '2' : G.trumpMode === 'asners' ? 'A2' : 'A');
                }
            }
        }

        function aiPick(pid) {
            const can = playable(pid);
            const hi = [...can].sort((a, b) => cardVal(b, G.trumpMode) - cardVal(a, G.trumpMode));
            const lo = [...can].sort((a, b) => cardVal(a, G.trumpMode) - cardVal(b, G.trumpMode));
            const partner = PARTNER[pid];
            const win = G.trick.length ? trickWinner(G.trick, G.leadSuit, G.trumpMode, G.trump) : null;
            const partnerWin = win && win.player === partner;
            const lead = G.trick.length === 0;

            if (lead) {
                const nonT = hi.filter(c => G.trumpMode !== 'normal' || c.suit !== G.trump);
                if (nonT.length) {
                    const ace = nonT.find(c => c.rank === 'A');
                    if (ace) return ace;
                    for (const c of nonT) if (c.rank === 'K' && G.memory.aces[c.suit]) return c;
                    return nonT[Math.floor(nonT.length / 2)];
                }
                return hi[Math.floor(hi.length / 2)];
            }

            const mustFollow = can.some(c => c.suit === G.leadSuit);

            if (partnerWin) {
                if (mustFollow) return lo.filter(c => c.suit === G.leadSuit)[0];
                const nt = lo.filter(c => G.trumpMode !== 'normal' || c.suit !== G.trump);
                return nt.length ? nt[0] : lo[0];
            }

            if (mustFollow) {
                const suit = hi.filter(c => c.suit === G.leadSuit);
                const best = G.trick.filter(t => t.card.suit === G.leadSuit)
                    .reduce((m, t) => !m || cardVal(t.card, G.trumpMode) > cardVal(m, G.trumpMode) ? t.card : m, null);
                if (best) {
                    const beats = suit.filter(c => cardVal(c, G.trumpMode) > cardVal(best, G.trumpMode));
                    if (beats.length) return beats[beats.length - 1];
                }
                return suit[suit.length - 1];
            }

            const trumps = hi.filter(c => G.trumpMode === 'normal' && c.suit === G.trump);
            const nonT = lo.filter(c => G.trumpMode !== 'normal' || c.suit !== G.trump);
            const oppWin = win && G.players[win.player].team !== G.players[pid].team;

            if (oppWin && trumps.length) {
                const wc = win.card;
                const wt = G.trumpMode === 'normal' && wc.suit === G.trump;
                if (!wt) return trumps[trumps.length - 1];
                const higher = trumps.filter(c => cardVal(c, G.trumpMode) > cardVal(wc, G.trumpMode));
                if (higher.length) return higher[higher.length - 1];
            }

            return nonT.length ? nonT[0] : lo[0];
        }

        async function nextTurn() {
            if (G.trick.length === 4) { await endTrick(); return; }
            G.current = NEXT[G.current];
            updateUI();
            if (G.current !== 1) {
                await delay(550);
                doPlayCard(G.current, aiPick(G.current));
                await nextTurn();
            } else {
                G.processing = false;
                G.selectedCard = null;
                renderHand();
            }
        }

        async function endTrick() {
            G.phase = 'trickEnd';
            const w = trickWinner(G.trick, G.leadSuit, G.trumpMode, G.trump);
            G.tricksWon[G.players[w.player].team]++;
            updateUI();
            showPopup(`${G.players[w.player].name} ÿ®ÿ±ÿØ!`);
            await delay(1000);
            hidePopup();
            G.starter = w.player;

            if (G.tricksWon.A >= 7 || G.tricksWon.B >= 7) {
                if (G.tricksWon.A === 7 && G.tricksWon.B === 0) { await handleKot('A'); return; }
                if (G.tricksWon.B === 7 && G.tricksWon.A === 0) { await handleKot('B'); return; }
                await endRound(); return;
            }
            if (G.trickNum === 13) { await endRound(); return; }
            await startTrick();
        }

        function showPopup(t) { const p = $('winnerPopup'); p.textContent = t; p.classList.add('show'); }
        function hidePopup() { $('winnerPopup').classList.remove('show'); }

        async function handleKot(team) {
            G.kotTeam = team;
            const hTeam = G.players[G.hakem].team;
            const pts = team !== hTeam ? 3 : 2;
            if (team === 'A') {
                $('kotMsg').textContent = `⁄©ÿ™ ⁄©ÿ±ÿØ€åÿØ! (+${pts})`;
                $('kotModal').classList.add('show');
            } else {
                if (Math.random() < 0.2) { G.bamReq = true; await startTrick(); }
                else { G.score[team] += pts; await endRound(); }
            }
        }

        async function endRound() {
            G.phase = 'roundEnd';
            let winner = null, pts = 0;
            if (G.bamReq && G.tricksWon[G.kotTeam] === 13) { G.score[G.kotTeam] = 7; checkGameEnd(); return; }
            if (G.kotTeam && !G.bamReq) {
                const hTeam = G.players[G.hakem].team;
                pts = G.kotTeam !== hTeam ? 3 : 2;
                G.score[G.kotTeam] += pts; winner = G.kotTeam;
            } else if (G.bamReq) {
                const hTeam = G.players[G.hakem].team;
                pts = G.kotTeam !== hTeam ? 3 : 2;
                G.score[G.kotTeam] += pts; winner = G.kotTeam;
            } else {
                if (G.tricksWon.A >= 7) { winner = 'A'; pts = 1; G.score.A++; }
                else if (G.tricksWon.B >= 7) { winner = 'B'; pts = 1; G.score.B++; }
            }
            updateUI();
            const hTeam = G.players[G.hakem].team;
            if (winner && winner !== hTeam) G.hakem = NEXT[G.hakem];
            if (checkGameEnd()) return;
            $('roundTitle').textContent = winner === 'A' ? 'ÿ®ÿ±ŸÜÿØŸá ÿ¥ÿØ€åÿØ!' : 'ÿ®ÿßÿÆÿ™€åÿØ';
            $('roundTitle').style.color = winner === 'A' ? '#4ecdc4' : '#ff6b6b';
            $('roundMsg').innerHTML = `ÿØÿ≥ÿ™‚ÄåŸáÿß: ${G.tricksWon.A} - ${G.tricksWon.B}<br>ÿßŸÖÿ™€åÿßÿ≤: +${pts}<br><br>⁄©ŸÑ: ${G.score.A} - ${G.score.B}`;
            $('roundModal').classList.add('show');
        }

        function checkGameEnd() {
            if (G.score.A >= 7) { showEnd('A'); return true; }
            if (G.score.B >= 7) { showEnd('B'); return true; }
            return false;
        }

        function showEnd(w) {
            $('endTitle').textContent = w === 'A' ? 'üéâ ÿ®ÿ±ŸÜÿØŸá ÿ¥ÿØ€åÿØ!' : 'ÿ®ÿßÿÆÿ™€åÿØ';
            $('endTitle').style.color = w === 'A' ? '#4ecdc4' : '#ff6b6b';
            $('endMsg').innerHTML = `${G.score.A} - ${G.score.B}`;
            $('endModal').classList.add('show');
        }

        async function startTrick() {
            G.trickNum++;
            G.trick = [];
            G.leadSuit = null;
            G.phase = 'play';
            G.processing = false;
            G.selectedCard = null;
            clearTable();
            if (G.trickNum === 1) G.starter = G.hakem;
            G.current = G.starter;
            updateUI();
            renderHand();
            if (G.current !== 1) {
                G.processing = true;
                await delay(550);
                doPlayCard(G.current, aiPick(G.current));
                await nextTurn();
            }
        }

        async function dealRest() {
            let i = 0;
            for (let r = 0; r < 8; r++) {
                for (let p = 0; p < 4; p++) {
                    const pid = ((G.hakem - 1 + p) % 4) + 1;
                    G.players[pid].hand.push(G.deck[20 + i++]);
                }
            }
            for (let p = 1; p <= 4; p++) G.players[p].hand = sortHand(G.players[p].hand, G.trump, G.trumpMode);
            renderHand();
            await delay(300);
            await startTrick();
        }

        function setTrump(mode, suit) { G.trumpMode = mode; G.trump = suit; updateUI(); }

        function showTrumpPicker() {
            const cont = $('previewCards');
            cont.innerHTML = '';
            for (const c of sortHand(G.players[1].hand.slice(0, 5), null, 'normal')) cont.appendChild(createCard(c));
            $('trumpModal').classList.add('show');
        }

        async function selectTrump() {
            G.phase = 'trump';
            if (G.hakem === 1) { showTrumpPicker(); }
            else {
                await delay(700);
                const h = G.players[G.hakem].hand.slice(0, 5);
                const scores = { spades: 0, hearts: 0, diamonds: 0, clubs: 0 };
                for (const c of h) {
                    scores[c.suit] += cardVal(c, 'normal');
                    if (c.rank === 'A') scores[c.suit] += 20;
                    if (c.rank === 'K') scores[c.suit] += 10;
                }
                let best = 'spades', bs = 0;
                for (const s of SUITS) if (scores[s] > bs) { bs = scores[s]; best = s; }
                setTrump('normal', best);
                await dealRest();
            }
        }

        async function dealFirst() {
            G.phase = 'deal';
            G.deck = shuffle(makeDeck());
            let i = 0;
            for (let r = 0; r < 5; r++) {
                for (let p = 0; p < 4; p++) {
                    const pid = ((G.hakem - 1 + p) % 4) + 1;
                    G.players[pid].hand.push(G.deck[i++]);
                }
            }
            renderHand();
            await selectTrump();
        }

        async function startRound() {
            G.tricksWon = { A: 0, B: 0 };
            G.trickNum = 0;
            G.trump = null;
            G.trumpMode = 'normal';
            G.trick = [];
            G.leadSuit = null;
            G.kotTeam = null;
            G.bamReq = false;
            G.processing = false;
            G.selectedCard = null;
            G.memory = { played: [], voids: {}, aces: {}, kings: {} };
            for (let i = 1; i <= 4; i++) G.players[i].hand = [];
            updateUI();
            clearTable();
            await dealFirst();
        }

        function startGame() {
            $('startScreen').classList.add('hidden');
            $('gameWrapper').classList.remove('hidden');
            G.score = { A: 0, B: 0 };
            G.hakem = Math.floor(Math.random() * 4) + 1;
            startRound();
        }

        $('startBtn').onclick = startGame;

        document.querySelectorAll('.trump-btn').forEach(b => {
            b.onclick = () => {
                const t = b.dataset.trump;
                $('trumpModal').classList.remove('show');
                if (['ners', 'asners', 'sers'].includes(t)) setTrump(t, null);
                else setTrump('normal', t);
                dealRest();
            };
        });

        $('nextRoundBtn').onclick = () => { $('roundModal').classList.remove('show'); startRound(); };
        $('newGameBtn').onclick = () => { $('endModal').classList.remove('show'); G.score = { A: 0, B: 0 }; G.hakem = Math.floor(Math.random() * 4) + 1; startRound(); };
        $('bamYes').onclick = () => { $('kotModal').classList.remove('show'); G.bamReq = true; startTrick(); };
        $('bamNo').onclick = () => { $('kotModal').classList.remove('show'); const hTeam = G.players[G.hakem].team; G.score[G.kotTeam] += G.kotTeam !== hTeam ? 3 : 2; endRound(); };
    })();
    </script>
</body>
</html>
