<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بازی حکم - نسخه حرفه‌ای</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="/hokm/favicon.ico">
    <style>
        :root {
            --primary-green: #1e6b3a;
            --dark-green: #0f3d1f;
            --gold: #f4c430;
            --gold-light: #ffe066;
            --red: #e63946;
            --black: #1d1d1d;
            --white: #ffffff;
            --card-shadow: 0 8px 25px rgba(0,0,0,0.4);
            --glass-bg: rgba(255,255,255,0.08);
            --glass-border: rgba(255,255,255,0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a2615 0%, var(--dark-green) 30%, var(--primary-green) 70%, #0a2615 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--white);
        }

        .game-container {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            padding: 8px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
        }

        .game-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--gold);
        }

        .score-display {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }

        .team-score {
            padding: 8px 16px;
            border-radius: 25px;
            background: rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .team-score.team-a { border: 2px solid #4ecdc4; }
        .team-score.team-b { border: 2px solid #ff6b6b; }

        .game-table {
            flex: 1;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 8px;
        }

        .player-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-radius: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            transition: var(--transition);
            overflow: hidden;
        }

        .player-area.active {
            box-shadow: 0 0 30px rgba(244, 196, 48, 0.5);
            border: 2px solid var(--gold);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-name { font-weight: 600; font-size: 0.9rem; }

        .player-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .crown-icon {
            color: var(--gold);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .trump-badge {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--black);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .top-player {
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
        }

        .middle-section {
            display: grid;
            grid-template-columns: 120px 1fr 120px;
            gap: 10px;
            align-items: center;
        }

        .side-player {
            width: 120px;
            min-height: 130px;
        }

        .play-area {
            background: radial-gradient(ellipse at center, #2d5a28 0%, #1a3d1a 60%, #0f2810 100%);
            border-radius: 50%;
            aspect-ratio: 1.4;
            max-height: 300px;
            margin: 0 auto;
            display: grid;
            grid-template-areas:
                ". top ."
                "left center right"
                ". bottom .";
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            padding: 20px;
            box-shadow: 
                inset 0 0 60px rgba(0,0,0,0.6),
                0 0 0 6px #3d2614,
                0 0 0 10px #5c3d1e;
            width: 100%;
            max-width: 400px;
        }

        .played-card-slot {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .played-card-slot.top { grid-area: top; }
        .played-card-slot.left { grid-area: left; }
        .played-card-slot.right { grid-area: right; }
        .played-card-slot.bottom { grid-area: bottom; }

        .bottom-player { width: 100%; }

        .player-hand {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px;
            min-height: 110px;
        }

        /* کارت‌های بازیکن انسانی - بزرگتر */
        .card {
            width: 62px;
            height: 88px;
            border-radius: 8px;
            background: linear-gradient(165deg, #ffffff 0%, #f8f8f8 50%, #e8e8e8 100%);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px 5px;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative;
            user-select: none;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .card:hover:not(.disabled) {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card.trump-card {
            border: 2px solid var(--gold);
            box-shadow: var(--card-shadow), 0 0 15px rgba(244, 196, 48, 0.4);
        }

        .card-corner {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: bold;
            line-height: 1;
        }

        .card-corner.top-left { align-self: flex-start; }
        .card-corner.bottom-right {
            align-self: flex-end;
            transform: rotate(180deg);
        }

        .card-rank { font-size: 1rem; font-weight: 700; }
        .card-suit { font-size: 1.1rem; }

        .card.red .card-corner { color: var(--red); }
        .card.black .card-corner { color: var(--black); }

        .card-center {
            font-size: 1.6rem;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .card.red .card-center { color: var(--red); }
        .card.black .card-center { color: var(--black); }

        /* کارت‌های وسط میز - بزرگتر */
        .played-card {
            width: 56px;
            height: 78px;
            animation: playCard 0.3s ease-out;
        }

        .played-card .card-rank { font-size: 0.9rem; }
        .played-card .card-suit { font-size: 1rem; }
        .played-card .card-center { font-size: 1.4rem; }

        @keyframes playCard {
            from { transform: scale(0.3) translateY(60px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .ai-cards {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2px;
            padding: 2px;
        }

        .ai-card-back {
            width: 22px;
            height: 32px;
            border-radius: 3px;
            background: linear-gradient(145deg, #2a2a6e 0%, #1a1a4e 50%, #2a2a6e 100%);
            box-shadow: 1px 1px 4px rgba(0,0,0,0.4);
            border: 1px solid #4a4a9e;
        }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(165deg, #2a2a4a 0%, #1a1a2e 100%);
            border-radius: 24px;
            padding: 25px;
            max-width: 90%;
            text-align: center;
            border: 2px solid var(--gold);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 15px;
        }

        .trump-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .trump-btn {
            padding: 15px;
            border-radius: 14px;
            border: 2px solid transparent;
            font-size: 1.3rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .trump-btn:hover {
            border-color: var(--gold);
            transform: scale(1.05);
        }

        .trump-btn.spades { color: var(--black); background: #f0f0f0; }
        .trump-btn.hearts { color: var(--red); background: #ffe8e8; }
        .trump-btn.diamonds { color: var(--red); background: #ffe8e8; }
        .trump-btn.clubs { color: var(--black); background: #f0f0f0; }

        .special-trump-btn {
            grid-column: span 2;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1rem;
        }

        .trump-btn-label { font-size: 0.7rem; }

        .info-panel {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.85);
            padding: 10px 15px;
            display: flex;
            justify-content: center;
            z-index: 100;
        }

        .round-info {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: var(--glass-bg);
            border-radius: 15px;
        }

        .info-item i { color: var(--gold); }

        .action-btn {
            padding: 12px 28px;
            border-radius: 30px;
            border: none;
            background: linear-gradient(135deg, var(--gold), #e6b800);
            color: var(--black);
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .trick-winner-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .trick-winner-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .winner-message {
            background: linear-gradient(135deg, var(--gold), #e6b800);
            padding: 20px 40px;
            border-radius: 16px;
            color: var(--black);
            font-size: 1.3rem;
            font-weight: 700;
            animation: bounceIn 0.4s ease;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .start-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(145deg, #0a2615 0%, var(--dark-green) 50%, #0a2615 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .start-title {
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .start-subtitle {
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 40px;
        }

        .start-btn {
            padding: 18px 60px;
            font-size: 1.2rem;
            border-radius: 50px;
            border: none;
            background: linear-gradient(135deg, var(--gold), #e6b800);
            color: var(--black);
            font-weight: 700;
            cursor: pointer;
        }

        .start-btn:hover {
            transform: translateY(-5px);
        }

        .card-decoration {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            font-size: 4rem;
        }

        .card-decoration span {
            animation: float 3s ease-in-out infinite;
        }

        .card-decoration span:nth-child(1) { color: #1d1d1d; }
        .card-decoration span:nth-child(2) { color: #e63946; animation-delay: 0.5s; }
        .card-decoration span:nth-child(3) { color: #e63946; animation-delay: 1s; }
        .card-decoration span:nth-child(4) { color: #1d1d1d; animation-delay: 1.5s; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @media (max-width: 768px) {
            .game-header { flex-direction: column; gap: 8px; }
            .middle-section { grid-template-columns: 95px 1fr 95px; }
            .side-player { width: 95px; }
            .play-area { max-height: 240px; }
            .card { width: 54px; height: 76px; }
            .played-card { width: 48px; height: 68px; }
            .ai-card-back { width: 18px; height: 26px; }
        }

        @media (max-width: 480px) {
            .card { width: 46px; height: 66px; }
            .card-rank { font-size: 0.85rem; }
            .card-suit { font-size: 0.9rem; }
            .card-center { font-size: 1.3rem; }
            .played-card { width: 42px; height: 60px; }
            .middle-section { grid-template-columns: 80px 1fr 80px; }
            .side-player { width: 80px; }
            .play-area { max-height: 200px; padding: 12px; }
        }

        .game-log-toggle {
            position: fixed;
            top: 10px; left: 10px;
            z-index: 500;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
        }

        .game-log-toggle.hidden { display: none; }

        .game-log {
            position: fixed;
            top: 55px; left: 10px;
            width: 260px;
            max-height: 300px;
            background: rgba(0,0,0,0.95);
            border-radius: 10px;
            padding: 12px;
            overflow-y: auto;
            z-index: 500;
            font-size: 0.65rem;
            display: none;
        }

        .game-log.visible { display: block; }

        .log-entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .log-entry.info { color: #4ecdc4; }
        .log-entry.action { color: #ffe66d; }
        .log-entry.win { color: #4cd137; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="start-screen" id="startScreen">
        <div class="card-decoration">
            <span>♠</span><span>♥</span><span>♦</span><span>♣</span>
        </div>
        <h1 class="start-title">بازی حکم</h1>
        <p class="start-subtitle">نسخه حرفه‌ای چهار نفره</p>
        <button class="start-btn" id="startBtn"><i class="fas fa-play"></i> شروع بازی</button>
    </div>

    <div class="game-container" id="gameContainer" style="display: none;">
        <header class="game-header">
            <h1 class="game-title"><i class="fas fa-crown"></i> حکم</h1>
            <div class="score-display">
                <div class="team-score team-a"><i class="fas fa-users"></i> شما: <strong id="teamAScore">0</strong></div>
                <div class="team-score team-b"><i class="fas fa-robot"></i> حریف: <strong id="teamBScore">0</strong></div>
            </div>
        </header>

        <div class="game-table">
            <div class="player-area top-player" id="player3Area">
                <div class="player-info">
                    <div class="player-avatar"><i class="fas fa-user"></i></div>
                    <span class="player-name">یار شما</span>
                    <span class="crown-icon hidden" id="crown3"><i class="fas fa-crown"></i></span>
                    <span class="trump-badge hidden" id="trump3"></span>
                </div>
                <div class="ai-cards" id="player3Cards"></div>
            </div>

            <div class="middle-section">
                <div class="player-area side-player" id="player4Area">
                    <div class="player-info">
                        <div class="player-avatar"><i class="fas fa-robot"></i></div>
                        <span class="player-name">حریف۲</span>
                        <span class="crown-icon hidden" id="crown4"><i class="fas fa-crown"></i></span>
                        <span class="trump-badge hidden" id="trump4"></span>
                    </div>
                    <div class="ai-cards" id="player4Cards"></div>
                </div>

                <div class="play-area">
                    <div class="played-card-slot top" id="slot3"></div>
                    <div class="played-card-slot left" id="slot4"></div>
                    <div class="played-card-slot right" id="slot2"></div>
                    <div class="played-card-slot bottom" id="slot1"></div>
                </div>

                <div class="player-area side-player" id="player2Area">
                    <div class="player-info">
                        <div class="player-avatar"><i class="fas fa-robot"></i></div>
                        <span class="player-name">حریف۱</span>
                        <span class="crown-icon hidden" id="crown2"><i class="fas fa-crown"></i></span>
                        <span class="trump-badge hidden" id="trump2"></span>
                    </div>
                    <div class="ai-cards" id="player2Cards"></div>
                </div>
            </div>

            <div class="player-area bottom-player" id="player1Area">
                <div class="player-info">
                    <div class="player-avatar" style="background: linear-gradient(135deg, #4ecdc4, #44a08d);"><i class="fas fa-user"></i></div>
                    <span class="player-name">شما</span>
                    <span class="crown-icon hidden" id="crown1"><i class="fas fa-crown"></i></span>
                    <span class="trump-badge hidden" id="trump1"></span>
                </div>
                <div class="player-hand" id="player1Cards"></div>
            </div>
        </div>

        <div class="info-panel">
            <div class="round-info">
                <div class="info-item"><i class="fas fa-layer-group"></i> دست: <span id="trickCount">0</span>/13</div>
                <div class="info-item"><i class="fas fa-trophy"></i> شما: <span id="teamATricks">0</span></div>
                <div class="info-item"><i class="fas fa-flag"></i> حریف: <span id="teamBTricks">0</span></div>
                <div class="info-item"><i class="fas fa-chess-king"></i> حکم: <span id="currentTrump">-</span></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="trumpModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-crown"></i> انتخاب حکم</h2>
            <p style="margin-bottom: 12px; opacity: 0.8;">۵ کارت اول شما:</p>
            <div class="player-hand" id="previewCards" style="margin-bottom: 15px; justify-content: center;"></div>
            <div class="trump-selection">
                <button class="trump-btn spades" data-trump="spades"><span>♠</span><span class="trump-btn-label">پیک</span></button>
                <button class="trump-btn hearts" data-trump="hearts"><span>♥</span><span class="trump-btn-label">دل</span></button>
                <button class="trump-btn diamonds" data-trump="diamonds"><span>♦</span><span class="trump-btn-label">خشت</span></button>
                <button class="trump-btn clubs" data-trump="clubs"><span>♣</span><span class="trump-btn-label">گشنیز</span></button>
                <button class="trump-btn special-trump-btn" data-trump="ners"><span>(2)</span><span class="trump-btn-label">نرس</span></button>
                <button class="trump-btn special-trump-btn" data-trump="asners"><span>(A2)</span><span class="trump-btn-label">آس‌نرس</span></button>
                <button class="trump-btn special-trump-btn" data-trump="sers"><span>(A)</span><span class="trump-btn-label">سرس</span></button>
            </div>
        </div>
    </div>

    <div class="trick-winner-overlay" id="trickWinnerOverlay">
        <div class="winner-message" id="winnerMessage"></div>
    </div>

    <div class="modal-overlay" id="roundEndModal">
        <div class="modal-content">
            <h2 class="modal-title" id="roundEndTitle">پایان راند</h2>
            <p id="roundEndMessage"></p>
            <button class="action-btn" id="nextRoundBtn" style="margin-top: 15px;">راند بعدی</button>
        </div>
    </div>

    <div class="modal-overlay" id="gameEndModal">
        <div class="modal-content">
            <h2 class="modal-title" id="gameEndTitle">پایان بازی</h2>
            <p id="gameEndMessage" style="margin: 15px 0;"></p>
            <button class="action-btn" id="newGameBtn"><i class="fas fa-redo"></i> بازی جدید</button>
        </div>
    </div>

    <div class="modal-overlay" id="kotBamModal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-trophy"></i> کت!</h2>
            <p id="kotMessage" style="margin-bottom: 15px;"></p>
            <p>آیا تقاضای بام دارید؟</p>
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 15px;">
                <button class="action-btn" id="bamYesBtn">بله، بام!</button>
                <button class="action-btn" id="bamNoBtn" style="background: #666;">خیر</button>
            </div>
        </div>
    </div>

    <button class="game-log-toggle hidden" id="logToggle"><i class="fas fa-list"></i></button>
    <div class="game-log" id="gameLog"></div>

    <script>
        (function() {
            'use strict';
            
            const State = {
                players: {
                    1: { name: 'شما', hand: [], isHuman: true, team: 'A' },
                    2: { name: 'حریف۱', hand: [], isHuman: false, team: 'B' },
                    3: { name: 'یار شما', hand: [], isHuman: false, team: 'A' },
                    4: { name: 'حریف۲', hand: [], isHuman: false, team: 'B' }
                },
                hakem: null,
                trump: null,
                trumpMode: 'normal',
                currentTrick: [],
                leadSuit: null,
                currentPlayer: null,
                trickStarter: null,
                tricksWon: { A: 0, B: 0 },
                totalScore: { A: 0, B: 0 },
                trickCount: 0,
                roundCount: 0,
                gamePhase: 'waiting',
                isProcessing: false,
                remainingDeck: [],
                aiMemory: {
                    playedCards: [],
                    voids: {},
                    acesPlayed: { spades: false, hearts: false, diamonds: false, clubs: false },
                    kingsPlayed: { spades: false, hearts: false, diamonds: false, clubs: false },
                    cardsRemaining: { spades: 13, hearts: 13, diamonds: 13, clubs: 13 }
                },
                kotPending: false,
                bamRequested: false,
                kotTeam: null
            };

            const SUITS = ['spades', 'hearts', 'diamonds', 'clubs'];
            const SUIT_SYMBOLS = { spades: '♠', hearts: '♥', diamonds: '♦', clubs: '♣' };
            const SUIT_NAMES = { spades: 'پیک', hearts: 'دل', diamonds: 'خشت', clubs: 'گشنیز' };
            const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

            // ترتیب بازی: ساعتگرد از نظر بازیکن (پایین)
            // 1 (پایین) -> 2 (راست) -> 3 (بالا) -> 4 (چپ) -> 1
            const NEXT_PLAYER = { 1: 4, 4: 3, 3: 2, 2: 1 };
            const PARTNER = { 1: 3, 2: 4, 3: 1, 4: 2 };

            function log(msg, type = 'info') {
                console.log(`[${type}] ${msg}`);
                const logDiv = document.getElementById('gameLog');
                if (logDiv) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${type}`;
                    entry.textContent = msg;
                    logDiv.appendChild(entry);
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            }

            function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

            function createDeck() {
                const deck = [];
                for (const suit of SUITS) {
                    for (const rank of RANKS) {
                        deck.push({ suit, rank });
                    }
                }
                return deck;
            }

            function shuffleDeck(deck) {
                const arr = [...deck];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            function getCardValue(card, mode) {
                const r = card.rank;
                if (mode === 'ners') {
                    const order = ['A', 'K', 'Q', 'J', '10', '9', '8', '7', '6', '5', '4', '3', '2'];
                    return order.length - order.indexOf(r);
                } else if (mode === 'asners') {
                    const order = ['K', 'Q', 'J', '10', '9', '8', '7', '6', '5', '4', '3', '2', 'A'];
                    return order.length - order.indexOf(r);
                } else {
                    const order = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                    return order.indexOf(r) + 1;
                }
            }

            function compareCards(c1, c2, leadSuit, mode, trumpSuit) {
                const t1 = mode === 'normal' && c1.suit === trumpSuit;
                const t2 = mode === 'normal' && c2.suit === trumpSuit;
                const l1 = c1.suit === leadSuit;
                const l2 = c2.suit === leadSuit;

                if (mode === 'sers') {
                    if (l1 && !l2) return 1;
                    if (!l1 && l2) return -1;
                    if (!l1 && !l2) return 0;
                    return getCardValue(c1, mode) - getCardValue(c2, mode);
                }

                if (t1 && !t2) return 1;
                if (!t1 && t2) return -1;
                if (t1 && t2) return getCardValue(c1, mode) - getCardValue(c2, mode);
                if (l1 && !l2) return 1;
                if (!l1 && l2) return -1;
                if (l1 && l2) return getCardValue(c1, mode) - getCardValue(c2, mode);
                return 0;
            }

            function findTrickWinner(trick, leadSuit, mode, trumpSuit) {
                let winner = trick[0];
                for (let i = 1; i < trick.length; i++) {
                    if (compareCards(trick[i].card, winner.card, leadSuit, mode, trumpSuit) > 0) {
                        winner = trick[i];
                    }
                }
                return winner;
            }

            function sortHand(hand, trumpSuit, mode) {
                const suits = { spades: [], hearts: [], diamonds: [], clubs: [] };
                for (const c of hand) suits[c.suit].push(c);
                for (const s of SUITS) {
                    suits[s].sort((a, b) => getCardValue(b, mode) - getCardValue(a, mode));
                }
                const sorted = [];
                const order = ['spades', 'hearts', 'clubs', 'diamonds'];
                if (mode === 'normal' && trumpSuit) {
                    sorted.push(...suits[trumpSuit]);
                    for (const s of order.filter(x => x !== trumpSuit)) sorted.push(...suits[s]);
                } else {
                    for (const s of order) sorted.push(...suits[s]);
                }
                return sorted;
            }

            function createCardEl(card, playable = true, size = 'normal') {
                const el = document.createElement('div');
                const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
                const isTrump = State.trumpMode === 'normal' && card.suit === State.trump;
                let cls = `card ${isRed ? 'red' : 'black'}`;
                if (isTrump) cls += ' trump-card';
                if (!playable) cls += ' disabled';
                if (size === 'played') cls += ' played-card';
                el.className = cls;
                el.innerHTML = `
                    <div class="card-corner top-left">
                        <span class="card-rank">${card.rank}</span>
                        <span class="card-suit">${SUIT_SYMBOLS[card.suit]}</span>
                    </div>
                    <div class="card-center">${SUIT_SYMBOLS[card.suit]}</div>
                    <div class="card-corner bottom-right">
                        <span class="card-rank">${card.rank}</span>
                        <span class="card-suit">${SUIT_SYMBOLS[card.suit]}</span>
                    </div>
                `;
                return el;
            }

            function getPlayableCards(pid) {
                const hand = State.players[pid].hand;
                if (!State.leadSuit || State.currentTrick.length === 0) return hand;
                const sc = hand.filter(c => c.suit === State.leadSuit);
                return sc.length > 0 ? sc : hand;
            }

            function renderHand(pid) {
                const hand = State.players[pid].hand;
                const cont = document.getElementById(`player${pid}Cards`);
                cont.innerHTML = '';
                
                if (pid === 1) {
                    const sorted = sortHand(hand, State.trump, State.trumpMode);
                    State.players[1].hand = sorted;
                    const playable = getPlayableCards(1);
                    const myTurn = State.gamePhase === 'playing' && State.currentPlayer === 1 && !State.isProcessing;
                    
                    for (const c of sorted) {
                        const canPlay = myTurn && playable.some(x => x.suit === c.suit && x.rank === c.rank);
                        const el = createCardEl(c, canPlay);
                        if (canPlay) el.onclick = () => handleCardClick(c);
                        cont.appendChild(el);
                    }
                } else {
                    for (let i = 0; i < hand.length; i++) {
                        const back = document.createElement('div');
                        back.className = 'ai-card-back';
                        cont.appendChild(back);
                    }
                }
            }

            function renderAllHands() { for (let i = 1; i <= 4; i++) renderHand(i); }

            function renderPlayedCard(pid, card) {
                const slot = document.getElementById(`slot${pid}`);
                const el = createCardEl(card, true, 'played');
                slot.innerHTML = '';
                slot.appendChild(el);
            }

            function clearPlayArea() {
                for (let i = 1; i <= 4; i++) document.getElementById(`slot${i}`).innerHTML = '';
            }

            function updateScores() {
                document.getElementById('teamAScore').textContent = State.totalScore.A;
                document.getElementById('teamBScore').textContent = State.totalScore.B;
                document.getElementById('teamATricks').textContent = State.tricksWon.A;
                document.getElementById('teamBTricks').textContent = State.tricksWon.B;
                document.getElementById('trickCount').textContent = State.trickCount;
                
                let trumpDisp = '-';
                if (State.trump || State.trumpMode !== 'normal') {
                    if (State.trumpMode === 'normal') trumpDisp = SUIT_SYMBOLS[State.trump];
                    else if (State.trumpMode === 'ners') trumpDisp = '(2)';
                    else if (State.trumpMode === 'asners') trumpDisp = '(A2)';
                    else trumpDisp = '(A)';
                }
                document.getElementById('currentTrump').textContent = trumpDisp;
            }

            function updateHakem() {
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`crown${i}`).classList.add('hidden');
                    document.getElementById(`trump${i}`).classList.add('hidden');
                }
                if (State.hakem) {
                    document.getElementById(`crown${State.hakem}`).classList.remove('hidden');
                    if (State.trump || State.trumpMode !== 'normal') {
                        const badge = document.getElementById(`trump${State.hakem}`);
                        badge.classList.remove('hidden');
                        if (State.trumpMode === 'normal') badge.textContent = SUIT_SYMBOLS[State.trump];
                        else if (State.trumpMode === 'ners') badge.textContent = '(2)';
                        else if (State.trumpMode === 'asners') badge.textContent = '(A2)';
                        else badge.textContent = '(A)';
                    }
                }
            }

            function updateActive() {
                for (let i = 1; i <= 4; i++) {
                    const area = document.getElementById(`player${i}Area`);
                    area.classList.toggle('active', i === State.currentPlayer);
                }
            }

            function getCurrentWinner() {
                if (State.currentTrick.length === 0) return null;
                return findTrickWinner(State.currentTrick, State.leadSuit, State.trumpMode, State.trump);
            }

            function isPartnerWinning(pid) {
                const winner = getCurrentWinner();
                if (!winner) return false;
                return winner.player === PARTNER[pid];
            }

            function getHighestPlayedInSuit(suit) {
                let highest = null;
                for (const played of State.currentTrick) {
                    if (played.card.suit === suit) {
                        if (!highest || getCardValue(played.card, State.trumpMode) > getCardValue(highest, State.trumpMode)) {
                            highest = played.card;
                        }
                    }
                }
                return highest;
            }

            // هوش مصنوعی پیشرفته
            function aiSelectCard(pid) {
                const hand = State.players[pid].hand;
                const playable = getPlayableCards(pid);
                const partner = PARTNER[pid];
                const myTeam = State.players[pid].team;
                const isLeading = State.currentTrick.length === 0;
                
                const sorted = [...playable].sort((a, b) => getCardValue(b, State.trumpMode) - getCardValue(a, State.trumpMode));
                const sortedAsc = [...playable].sort((a, b) => getCardValue(a, State.trumpMode) - getCardValue(b, State.trumpMode));
                
                const winner = getCurrentWinner();
                const partnerWinning = winner && winner.player === partner;
                const iAmVoidInLead = State.leadSuit && !hand.some(c => c.suit === State.leadSuit);
                
                // --- شروع بازی (Leading) ---
                if (isLeading) {
                    // قانون: با خال حکم شروع نکن (مگر فقط حکم داشته باشی)
                    const nonTrumpCards = sorted.filter(c => 
                        State.trumpMode !== 'normal' || c.suit !== State.trump
                    );
                    
                    if (nonTrumpCards.length > 0) {
                        // آس غیر حکم
                        const ace = nonTrumpCards.find(c => c.rank === 'A');
                        if (ace) {
                            log(`${State.players[pid].name}: شروع با آس ${SUIT_NAMES[ace.suit]}`, 'action');
                            return ace;
                        }
                        
                        // شاه اگر آس رفته
                        for (const c of nonTrumpCards) {
                            if (c.rank === 'K' && State.aiMemory.acesPlayed[c.suit]) {
                                log(`${State.players[pid].name}: شروع با شاه (آس رفته)`, 'action');
                                return c;
                            }
                        }
                        
                        // کارت متوسط
                        return nonTrumpCards[Math.floor(nonTrumpCards.length / 2)];
                    }
                    
                    // فقط حکم داری
                    return sorted[Math.floor(sorted.length / 2)];
                }
                
                // --- دنبال کردن ---
                const mustFollow = playable.some(c => c.suit === State.leadSuit);
                
                // اگر یار برنده است
                if (partnerWinning) {
                    // کمترین کارت را بزن
                    log(`${State.players[pid].name}: یار برنده - کمترین`, 'action');
                    
                    if (mustFollow) {
                        const suitCards = sortedAsc.filter(c => c.suit === State.leadSuit);
                        return suitCards[0];
                    }
                    
                    // خالی هستم - نباید حکم بزنم
                    const nonTrumps = sortedAsc.filter(c => 
                        State.trumpMode !== 'normal' || c.suit !== State.trump
                    );
                    if (nonTrumps.length > 0) return nonTrumps[0];
                    return sortedAsc[0];
                }
                
                // اگر باید دنبال کنم
                if (mustFollow) {
                    const suitCards = sorted.filter(c => c.suit === State.leadSuit);
                    const highestPlayed = getHighestPlayedInSuit(State.leadSuit);
                    
                    // سعی کن ببری با کارت بالاتر
                    if (highestPlayed) {
                        const canBeat = suitCards.filter(c => 
                            getCardValue(c, State.trumpMode) > getCardValue(highestPlayed, State.trumpMode)
                        );
                        if (canBeat.length > 0) {
                            // کمترین کارتی که می‌بره
                            const winner = canBeat[canBeat.length - 1];
                            log(`${State.players[pid].name}: می‌برم با ${winner.rank}`, 'action');
                            return winner;
                        }
                    }
                    
                    // نمی‌تونم ببرم - کمترین
                    return suitCards[suitCards.length - 1];
                }
                
                // --- خالی هستم ---
                const trumpCards = sorted.filter(c => 
                    State.trumpMode === 'normal' && c.suit === State.trump
                );
                const nonTrumpCards = sortedAsc.filter(c => 
                    State.trumpMode !== 'normal' || c.suit !== State.trump
                );
                
                // آیا حریف برنده است؟
                const opponentWinning = winner && State.players[winner.player].team !== myTeam;
                
                if (opponentWinning && trumpCards.length > 0) {
                    const winnerCard = winner.card;
                    const winnerIsTrump = State.trumpMode === 'normal' && winnerCard.suit === State.trump;
                    
                    if (!winnerIsTrump) {
                        // برش با کمترین حکم
                        log(`${State.players[pid].name}: برش!`, 'action');
                        return trumpCards[trumpCards.length - 1];
                    }
                    
                    // باید حکم بالاتر بزنم
                    const higherTrumps = trumpCards.filter(c => 
                        getCardValue(c, State.trumpMode) > getCardValue(winnerCard, State.trumpMode)
                    );
                    if (higherTrumps.length > 0) {
                        log(`${State.players[pid].name}: حکم بالاتر`, 'action');
                        return higherTrumps[higherTrumps.length - 1];
                    }
                }
                
                // رد بده - کمترین غیر حکم
                if (nonTrumpCards.length > 0) {
                    return nonTrumpCards[0];
                }
                
                return sortedAsc[0];
            }

            function aiSelectTrump(pid) {
                const hand = State.players[pid].hand.slice(0, 5);
                const scores = { spades: 0, hearts: 0, diamonds: 0, clubs: 0 };
                
                for (const c of hand) {
                    scores[c.suit] += getCardValue(c, 'normal');
                    if (c.rank === 'A') scores[c.suit] += 20;
                    if (c.rank === 'K') scores[c.suit] += 10;
                }
                
                let best = 'spades';
                let bestScore = 0;
                for (const s of SUITS) {
                    if (scores[s] > bestScore) {
                        bestScore = scores[s];
                        best = s;
                    }
                }
                
                log(`AI ${pid} حکم: ${SUIT_NAMES[best]}`, 'action');
                return { mode: 'normal', suit: best };
            }

            function playCard(pid, card) {
                const player = State.players[pid];
                const idx = player.hand.findIndex(c => c.suit === card.suit && c.rank === card.rank);
                if (idx > -1) player.hand.splice(idx, 1);
                
                State.currentTrick.push({ player: pid, card });
                if (State.currentTrick.length === 1) State.leadSuit = card.suit;
                
                // بروزرسانی حافظه
                State.aiMemory.playedCards.push({ ...card });
                State.aiMemory.cardsRemaining[card.suit]--;
                if (card.rank === 'A') State.aiMemory.acesPlayed[card.suit] = true;
                if (card.rank === 'K') State.aiMemory.kingsPlayed[card.suit] = true;
                
                if (State.leadSuit && card.suit !== State.leadSuit) {
                    if (!State.aiMemory.voids[pid]) State.aiMemory.voids[pid] = [];
                    if (!State.aiMemory.voids[pid].includes(State.leadSuit)) {
                        State.aiMemory.voids[pid].push(State.leadSuit);
                        log(`${player.name} خالی از ${SUIT_NAMES[State.leadSuit]}`, 'info');
                    }
                }
                
                log(`${player.name}: ${card.rank}${SUIT_SYMBOLS[card.suit]}`, 'action');
                renderPlayedCard(pid, card);
                renderHand(pid);
            }

            async function handleCardClick(card) {
                if (State.currentPlayer !== 1 || State.gamePhase !== 'playing' || State.isProcessing) return;
                
                const playable = getPlayableCards(1);
                if (!playable.some(c => c.suit === card.suit && c.rank === card.rank)) return;
                
                State.isProcessing = true;
                playCard(1, card);
                await nextPlayer();
            }

            async function nextPlayer() {
                if (State.currentTrick.length === 4) {
                    await endTrick();
                    return;
                }
                
                State.currentPlayer = NEXT_PLAYER[State.currentPlayer];
                updateActive();
                
                if (State.currentPlayer !== 1) {
                    await aiTurn();
                } else {
                    State.isProcessing = false;
                    renderHand(1);
                }
            }

            async function aiTurn() {
                await delay(700);
                const card = aiSelectCard(State.currentPlayer);
                playCard(State.currentPlayer, card);
                await nextPlayer();
            }

            function showWinner(pid) {
                const overlay = document.getElementById('trickWinnerOverlay');
                document.getElementById('winnerMessage').textContent = `${State.players[pid].name} برد!`;
                overlay.classList.add('active');
            }

            function hideWinner() {
                document.getElementById('trickWinnerOverlay').classList.remove('active');
            }

            async function endTrick() {
                State.gamePhase = 'trickEnd';
                State.isProcessing = true;
                
                const winner = findTrickWinner(State.currentTrick, State.leadSuit, State.trumpMode, State.trump);
                const team = State.players[winner.player].team;
                State.tricksWon[team]++;
                
                log(`برنده دست: ${State.players[winner.player].name}`, 'win');
                
                showWinner(winner.player);
                await delay(1200);
                hideWinner();
                
                updateScores();
                State.trickStarter = winner.player;
                
                // بررسی برد
                if (State.tricksWon.A >= 7 || State.tricksWon.B >= 7) {
                    if (State.tricksWon.A === 7 && State.tricksWon.B === 0) {
                        await handleKot('A');
                        return;
                    }
                    if (State.tricksWon.B === 7 && State.tricksWon.A === 0) {
                        await handleKot('B');
                        return;
                    }
                    await endRound();
                    return;
                }
                
                if (State.trickCount === 13) {
                    await endRound();
                    return;
                }
                
                await startTrick();
            }

            async function handleKot(team) {
                log(`کت! تیم ${team}`, 'win');
                State.kotPending = true;
                State.kotTeam = team;
                
                const hakemTeam = State.players[State.hakem].team;
                const pts = team !== hakemTeam ? 3 : 2;
                
                if (team === 'A') {
                    document.getElementById('kotMessage').textContent = `کت کردید! (+${pts} امتیاز)`;
                    document.getElementById('kotBamModal').classList.add('active');
                } else {
                    if (Math.random() < 0.2) {
                        State.bamRequested = true;
                        log('حریف درخواست بام!', 'action');
                        await startTrick();
                    } else {
                        State.totalScore[team] += pts;
                        await endRound();
                    }
                }
            }

            async function endRound() {
                State.gamePhase = 'roundEnd';
                log('=== پایان راند ===', 'info');
                
                let winner = null;
                let pts = 0;
                
                if (State.bamRequested && State.tricksWon[State.kotTeam] === 13) {
                    log('بام!', 'win');
                    State.totalScore[State.kotTeam] = 7;
                    await checkGameEnd();
                    return;
                }
                
                if (State.kotPending && !State.bamRequested) {
                    const hakemTeam = State.players[State.hakem].team;
                    pts = State.kotTeam !== hakemTeam ? 3 : 2;
                    State.totalScore[State.kotTeam] += pts;
                    winner = State.kotTeam;
                } else if (State.bamRequested && State.tricksWon[State.kotTeam] < 13) {
                    const hakemTeam = State.players[State.hakem].team;
                    pts = State.kotTeam !== hakemTeam ? 3 : 2;
                    State.totalScore[State.kotTeam] += pts;
                    winner = State.kotTeam;
                } else {
                    if (State.tricksWon.A >= 7) {
                        winner = 'A';
                        pts = 1;
                        State.totalScore.A += 1;
                    } else if (State.tricksWon.B >= 7) {
                        winner = 'B';
                        pts = 1;
                        State.totalScore.B += 1;
                    }
                }
                
                updateScores();
                
                const hakemTeam = State.players[State.hakem].team;
                if (winner && winner !== hakemTeam) {
                    State.hakem = NEXT_PLAYER[State.hakem];
                    log(`حاکم جدید: ${State.players[State.hakem].name}`, 'info');
                }
                
                if (await checkGameEnd()) return;
                
                const title = document.getElementById('roundEndTitle');
                const msg = document.getElementById('roundEndMessage');
                
                title.textContent = winner === 'A' ? 'تیم شما برنده!' : 'تیم حریف برنده';
                title.style.color = winner === 'A' ? '#4ecdc4' : '#ff6b6b';
                msg.innerHTML = `دست‌ها: شما ${State.tricksWon.A} - حریف ${State.tricksWon.B}<br>امتیاز: +${pts}<br><br>کل: شما ${State.totalScore.A} | حریف ${State.totalScore.B}`;
                document.getElementById('roundEndModal').classList.add('active');
            }

            async function checkGameEnd() {
                if (State.totalScore.A >= 7) { showGameEnd('A'); return true; }
                if (State.totalScore.B >= 7) { showGameEnd('B'); return true; }
                return false;
            }

            function showGameEnd(winner) {
                State.gamePhase = 'gameEnd';
                const title = document.getElementById('gameEndTitle');
                const msg = document.getElementById('gameEndMessage');
                
                title.textContent = winner === 'A' ? '🎉 برنده شدید! 🎉' : 'باختید!';
                title.style.color = winner === 'A' ? '#4ecdc4' : '#ff6b6b';
                msg.innerHTML = `شما: ${State.totalScore.A}<br>حریف: ${State.totalScore.B}`;
                document.getElementById('gameEndModal').classList.add('active');
            }

            async function startTrick() {
                State.trickCount++;
                State.currentTrick = [];
                State.leadSuit = null;
                State.gamePhase = 'playing';
                State.isProcessing = false;
                
                log(`--- دست ${State.trickCount} ---`, 'info');
                clearPlayArea();
                
                if (State.trickCount === 1) State.trickStarter = State.hakem;
                State.currentPlayer = State.trickStarter;
                
                updateActive();
                renderHand(1);
                
                if (State.currentPlayer !== 1) {
                    State.isProcessing = true;
                    await aiTurn();
                }
            }

            async function dealRemaining() {
                log('پخش بقیه کارت‌ها...', 'info');
                
                let idx = 0;
                for (let r = 0; r < 8; r++) {
                    for (let i = 0; i < 4; i++) {
                        const pid = ((State.hakem - 1 + i) % 4) + 1;
                        State.players[pid].hand.push(State.remainingDeck[idx++]);
                    }
                }
                
                for (let i = 1; i <= 4; i++) {
                    State.players[i].hand = sortHand(State.players[i].hand, State.trump, State.trumpMode);
                }
                
                renderAllHands();
                await delay(500);
                await startTrick();
            }

            function setTrump(mode, suit) {
                State.trumpMode = mode;
                State.trump = suit;
                log(`حکم: ${mode === 'normal' ? SUIT_NAMES[suit] : mode}`, 'action');
                updateScores();
                updateHakem();
            }

            function showTrumpModal() {
                const preview = document.getElementById('previewCards');
                preview.innerHTML = '';
                const sorted = sortHand(State.players[1].hand.slice(0, 5), null, 'normal');
                for (const c of sorted) preview.appendChild(createCardEl(c, false));
                document.getElementById('trumpModal').classList.add('active');
            }

            async function selectTrump() {
                State.gamePhase = 'trumpSelection';
                
                if (State.hakem === 1) {
                    showTrumpModal();
                } else {
                    await delay(1000);
                    const sel = aiSelectTrump(State.hakem);
                    setTrump(sel.mode, sel.suit);
                    await dealRemaining();
                }
            }

            async function dealInitial() {
                State.gamePhase = 'dealing';
                log('پخش ۵ کارت...', 'info');
                
                const deck = shuffleDeck(createDeck());
                
                let idx = 0;
                for (let r = 0; r < 5; r++) {
                    for (let i = 0; i < 4; i++) {
                        const pid = ((State.hakem - 1 + i) % 4) + 1;
                        State.players[pid].hand.push(deck[idx++]);
                    }
                }
                
                State.remainingDeck = deck.slice(20);
                renderAllHands();
                await selectTrump();
            }

            async function startRound() {
                State.roundCount++;
                log(`=== راند ${State.roundCount} ===`, 'info');
                
                State.tricksWon = { A: 0, B: 0 };
                State.trickCount = 0;
                State.trump = null;
                State.trumpMode = 'normal';
                State.currentTrick = [];
                State.leadSuit = null;
                State.kotPending = false;
                State.bamRequested = false;
                State.kotTeam = null;
                State.isProcessing = false;
                
                State.aiMemory = {
                    playedCards: [],
                    voids: {},
                    acesPlayed: { spades: false, hearts: false, diamonds: false, clubs: false },
                    kingsPlayed: { spades: false, hearts: false, diamonds: false, clubs: false },
                    cardsRemaining: { spades: 13, hearts: 13, diamonds: 13, clubs: 13 }
                };
                
                for (let i = 1; i <= 4; i++) State.players[i].hand = [];
                
                updateScores();
                updateHakem();
                clearPlayArea();
                renderAllHands();
                
                await dealInitial();
            }

            function startGame() {
                log('=== شروع بازی ===', 'info');
                
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'flex';
                document.getElementById('logToggle').classList.remove('hidden');
                
                State.totalScore = { A: 0, B: 0 };
                State.roundCount = 0;
                State.hakem = Math.floor(Math.random() * 4) + 1;
                
                log(`حاکم اولیه: ${State.players[State.hakem].name}`, 'info');
                
                startRound();
            }

            // Event Listeners
            document.getElementById('startBtn').onclick = startGame;

            document.querySelectorAll('.trump-btn').forEach(btn => {
                btn.onclick = function() {
                    const trump = btn.dataset.trump;
                    document.getElementById('trumpModal').classList.remove('active');
                    
                    if (['ners', 'asners', 'sers'].includes(trump)) {
                        setTrump(trump, null);
                    } else {
                        setTrump('normal', trump);
                    }
                    
                    dealRemaining();
                };
            });

            document.getElementById('nextRoundBtn').onclick = function() {
                document.getElementById('roundEndModal').classList.remove('active');
                startRound();
            };

            document.getElementById('newGameBtn').onclick = function() {
                document.getElementById('gameEndModal').classList.remove('active');
                State.totalScore = { A: 0, B: 0 };
                State.roundCount = 0;
                State.hakem = Math.floor(Math.random() * 4) + 1;
                startRound();
            };

            document.getElementById('bamYesBtn').onclick = function() {
                document.getElementById('kotBamModal').classList.remove('active');
                State.bamRequested = true;
                log('درخواست بام!', 'action');
                startTrick();
            };

            document.getElementById('bamNoBtn').onclick = function() {
                document.getElementById('kotBamModal').classList.remove('active');
                const hakemTeam = State.players[State.hakem].team;
                const pts = State.kotTeam !== hakemTeam ? 3 : 2;
                State.totalScore[State.kotTeam] += pts;
                endRound();
            };

            document.getElementById('logToggle').onclick = function() {
                document.getElementById('gameLog').classList.toggle('visible');
            };

            log('آماده. کلیک کنید.', 'info');
        })();
        // ثبت Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/hokm/sw.js')
    .then(reg => console.log('SW registered'))
    .catch(err => console.log('SW failed', err));
}
    </script>
</body>
</html>
